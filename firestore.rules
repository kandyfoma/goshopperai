rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user has active subscription
    function hasSubscription() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/artifacts/goshopper/users/$(request.auth.uid)/subscription/status) &&
        get(/databases/$(database)/documents/artifacts/goshopper/users/$(request.auth.uid)/subscription/status).data.isSubscribed == true;
    }
    
    // Subscriptions collection - NEW PATH
    match /artifacts/goshopper/subscriptions/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Allow creating initial subscription
      allow create: if isAuthenticated() && request.auth.uid == userId && request.resource.data.status == 'trial';
      // Allow user to update their own subscription (for scan tracking)
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // GoShopper user data (goshopper APP_ID)
    match /artifacts/goshopper/users/{userId} {
      // Allow user to create their own profile document on first signup
      allow create: if isOwner(userId);
      allow read, update, delete: if isOwner(userId);
      
      // Shopping times and patterns tracking
      match /shoppingTimes/{timeId} {
        allow read, write: if isOwner(userId);
      }
      
      match /shoppingDays/{dayId} {
        allow read, write: if isOwner(userId);
      }
      
      match /shopFrequency/{shopId} {
        allow read, write: if isOwner(userId);
      }
      
      match /shoppingPatterns/{patternId} {
        allow read, write: if isOwner(userId);
      }
      
      // User profile (deprecated - now using users/{userId} directly)
      match /profile/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // User's receipts - allow owner to read AND write
      match /receipts/{receiptId} {
        allow read, write: if isOwner(userId);
      }
      
      // User's shops (aggregated from receipts)
      match /shops/{shopId} {
        allow read, write: if isOwner(userId);
      }
      
      // User's items (aggregated from receipts)
      match /items/{itemId} {
        allow read, write: if isOwner(userId);
      }
      
      // Subscription status
      match /subscription/{document=**} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.status == 'trial';
        // Allow users to update scan counts and billing period fields only
        // Sensitive fields like isSubscribed, planId, etc. are protected by Cloud Functions
        allow update: if isOwner(userId) && (
          // Allow updating scan usage counts
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'trialScansUsed', 
            'monthlyScansUsed', 
            'currentBillingPeriodStart',
            'currentBillingPeriodEnd',
            'updatedAt',
            'status', // Allow status change for freemium transition
            'planId', // Allow planId change for freemium transition
            'isSubscribed' // Allow isSubscribed for freemium transition
          ])
        );
        allow delete: if false;
      }
      
      // Payment records
      match /payments/{paymentId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
      
      // Shopping Lists
      match /shoppingLists/{listId} {
        allow read, write: if isOwner(userId);
      }
      
      // Price Alerts
      match /priceAlerts/{alertId} {
        allow read, write: if isOwner(userId);
      }
      
      // Notifications
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
      
      // Monthly Budgets
      match /budgets/{monthKey} {
        allow read, write: if isOwner(userId);
      }
      
      // User Recommendations (ML/AI recommendations)
      match /recommendations/{recommendationId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // GoShopper public data
    match /artifacts/goshopper/public/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // Prices collection (aggregated price data for shopping optimization)
    // Read-only for authenticated users
    match /artifacts/goshopper/prices/{priceId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }
    
    // MASTER CITY ITEMS TABLE (community price database)
    // This is read-only for users - only Cloud Functions can write
    // Data persists even when users delete their receipts
    match /artifacts/goshopper/cityItems/{city}/items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }

    // User profiles collection (for phone number lookup during login)
    match /userProfiles/{profileId} {
      // Allow reading profiles for login purposes (phone number lookup)
      // This is safe because we don't expose sensitive data in the query
      allow read: if true;
      // Only allow users to create/update their own profile
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Password hashes collection (for phone login authentication)
    match /passwords/{userId} {
      // Allow reading password for verification during login
      // This is safe because the password is hashed and we need it for authentication
      allow read: if true;
      // Allow creating/updating password during registration or password change
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
