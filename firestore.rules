rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user has active subscription
    function hasSubscription() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/artifacts/goshopper/users/$(request.auth.uid)/subscription/status) &&
        get(/databases/$(database)/documents/artifacts/goshopper/users/$(request.auth.uid)/subscription/status).data.isSubscribed == true;
    }
    
    // Subscriptions collection - NEW PATH
    match /artifacts/goshopper/subscriptions/{userId} {
      // Allow read/write for both Firebase Auth users and phone-registered users
      allow read, write: if true;
    }
    
    // GoShopper user data (goshopper APP_ID)
    match /artifacts/goshopper/users/{userId} {
      // Allow creating profile during phone registration (before Firebase Auth)
      // This allows phone-based registration without Firebase Auth
      allow create: if request.resource.data.phoneNumber != null 
                    && request.resource.data.city != null
                    && request.resource.data.countryCode != null;
      // Allow owner to read/update/delete after authentication (Firebase Auth)
      // OR allow any read/update for phone-registered users (by document ID match)
      // Since phone users don't have Firebase Auth, we allow read/update based on document access
      allow read, update, delete: if true;
      
      // Shopping times and patterns tracking
      match /shoppingTimes/{timeId} {
        allow read, write: if true;
      }
      
      match /shoppingDays/{dayId} {
        allow read, write: if true;
      }
      
      match /shopFrequency/{shopId} {
        allow read, write: if true;
      }
      
      match /shoppingPatterns/{patternId} {
        allow read, write: if true;
      }
      
      // User profile (deprecated - now using users/{userId} directly)
      match /profile/{document=**} {
        allow read, write: if true;
      }
      
      // User's receipts - allow owner to read AND write
      match /receipts/{receiptId} {
        allow read, write: if true;
      }
      
      // User's shops (aggregated from receipts)
      match /shops/{shopId} {
        allow read, write: if true;
      }
      
      // User's items (aggregated from receipts)
      match /items/{itemId} {
        allow read, write: if true;
      }
      
      // Subscription status
      match /subscription/{document=**} {
        allow read, write: if true;
      }
      
      // Payment records
      match /payments/{paymentId} {
        allow read, write: if true;
      }
      
      // Shopping Lists
      match /shoppingLists/{listId} {
        allow read, write: if true;
      }
      
      // Price Alerts
      match /priceAlerts/{alertId} {
        allow read, write: if true;
      }
      
      // Notifications
      match /notifications/{notificationId} {
        allow read, write: if true;
      }
      
      // Monthly Budgets
      match /budgets/{monthKey} {
        allow read, write: if true;
      }
      
      // User Recommendations (ML/AI recommendations)
      match /recommendations/{recommendationId} {
        allow read, write: if true;
      }
    }
    
    // GoShopper public data
    match /artifacts/goshopper/public/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // Prices collection (aggregated price data for shopping optimization)
    // Read-only for authenticated users
    match /artifacts/goshopper/prices/{priceId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }
    
    // MASTER CITY ITEMS TABLE (community price database)
    // This is read-only for users - only Cloud Functions can write
    // Data persists even when users delete their receipts
    match /artifacts/goshopper/cityItems/{city}/items/{itemId} {
      allow read: if isAuthenticated();
      allow write, delete: if isAuthenticated(); // Allow authenticated users to delete (for dev tools)
    }

    // Public stores collection (for city detection)
    // Read-only for authenticated users - Cloud Functions manage this data
    match /artifacts/goshopper/stores/{storeId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }

    // User profiles collection (for phone number lookup during login)
    match /userProfiles/{profileId} {
      // Allow reading profiles for login purposes (phone number lookup)
      // This is safe because we don't expose sensitive data in the query
      allow read: if true;
      // Only allow users to create/update their own profile
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Password hashes collection (for phone login authentication)
    match /passwords/{userId} {
      // Allow reading password for verification during login
      // This is safe because the password is hashed and we need it for authentication
      allow read: if true;
      // Allow creating/updating password during registration or password change
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Global config collection (exchange rates, app settings)
    match /config/{document} {
      // Allow all users to read global config
      allow read: if true;
      // Only allow writes from server/admin (Cloud Functions)
      allow write: if false;
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
